---
import '../styles/global.css'
import LanguageSwitcher from '../components/LanguageSwitcher.astro';
import { loadLocaleSync } from '../utils/i18n';

// `astro:transitions` may not be available in every Astro setup/version.
// Import dynamically and render conditionally to avoid build-time errors.
let ViewTransitionsComponent = null;
try {
	// @ts-ignore - this import can fail in some environments
	ViewTransitionsComponent = (await import('astro:transitions')).ViewTransitions;
} catch (e) {
	// ignore - transitions unavailable
}

// Basic site-wide defaults. Update SITE_URL below to match your production domain.
const siteUrl = 'https://vazquezquilesaccounting.com';
const props = Astro.props as any;
const pageTitle = props?.title ? `${props.title} | Vázquez Quiles Accounting` : 'Vázquez Quiles Accounting';
const pageDescription = props?.description || 'Firma de contabilidad en Puerto Rico: contabilidad, preparación de planillas, nómina y consultoría financiera para negocios e individuos.';
const pageImage = props?.image || '/logo.png';
const pageUrl = props?.url || siteUrl;
const lang = props?.lang || 'es';
const localeData = loadLocaleSync(lang);
const allLocales = {
	es: loadLocaleSync('es'),
	en: loadLocaleSync('en')
};
const noindex = !!props?.noindex;
const preloadImage = props?.preloadImage || null;
---

<!doctype html>
<html lang={lang}>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<link rel="icon" type="image/x-icon" href="/logo.ico" />
		<meta name="generator" content={Astro.generator} />

		<title>{pageTitle}</title>
		<meta name="description" content={pageDescription} />
		<meta name="robots" content={noindex ? 'noindex, nofollow' : 'index, follow'} />
		<link rel="canonical" href={pageUrl} />

		<!-- Open Graph -->
		<meta property="og:type" content="website" />
		<meta property="og:title" content={pageTitle} />
		<meta property="og:description" content={pageDescription} />
		<meta property="og:url" content={pageUrl} />
		<meta property="og:image" content={pageImage} />
		<meta property="og:site_name" content="Vázquez Quiles Accounting" />

		<!-- Twitter -->
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:title" content={pageTitle} />
		<meta name="twitter:description" content={pageDescription} />
		<meta name="twitter:image" content={pageImage} />

		<!-- Sitemap hint -->
		<link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml" />

		{ViewTransitionsComponent ? <ViewTransitionsComponent /> : null}

		{preloadImage ? (
			<link rel="preload" as="image" href={preloadImage} />
		) : null}

		<!-- JSON-LD Organization (minimal). Edit contact details and social links as needed. -->
		<script type="application/ld+json">
			{JSON.stringify({
				"@context": "https://schema.org",
				"@type": "Organization",
				"name": "Vázquez Quiles Accounting",
				"url": siteUrl,
				"logo": `${siteUrl}/logo.png`,
				"contactPoint": [{
					"@type": "ContactPoint",
					"telephone": "+1-000-000-0000",
					"contactType": "customer service",
					"areaServed": "PR",
					"availableLanguage": ["Spanish","English"]
				}]
			})}
		</script>
	</head>
	<body>
		<slot />
			<!-- Expose locale data to the client for client-side fallback translations (base64 encoded) -->
			<script type="text/javascript">
				(function(){
					try {
						// Provide both locales to the client for switching without round-trips
						const localesB64 = "{Buffer.from(JSON.stringify(allLocales)).toString('base64')}";
						window.__LOCALES__ = JSON.parse(atob(localesB64));
					} catch (e) {
						window.__LOCALES__ = { es: {}, en: {} };
					}

					try {
						const b64 = "{Buffer.from(JSON.stringify(localeData)).toString('base64')}";
						window.__LOCALE__ = JSON.parse(atob(b64));
					} catch (e) {
						window.__LOCALE__ = {};
					}

					window.__LANG__ = "" + lang;
				})();
			</script>
		<LanguageSwitcher />
	</body>
</html>

<style>
	html,
	body {
		margin: 0;
		width: 100%;
		height: 100%;
		background-color: rgb(3, 3, 112);
	}
</style>
